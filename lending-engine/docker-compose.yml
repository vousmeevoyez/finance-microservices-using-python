# Docker Compose Production Environments 
version : '3'
services:
        flask:
                build:
                        context: .
                        dockerfile: dockerfiles/flask/Dockerfile
                image: lending-engine-services
                entrypoint: ./scripts/init.sh
                env_file: .env
                depends_on:
                - rabbitmq
                ports:
                - 11000:5000
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.rest

        investor-worker:
                image: lending-engine-services
                entrypoint: make investor-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.investor-worker

        utility-worker:
                image: lending-engine-services
                entrypoint: make utility-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.utility-worker

        transaction-worker:
                image: lending-engine-services
                entrypoint: make transaction-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.utility-worker

        investment-worker:
                image: lending-engine-services
                entrypoint: make investment-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.investment-worker

        va-worker:
                image: lending-engine-services
                entrypoint: make va-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.va-worker

        scheduler:
                image: lending-engine-services
                entrypoint: make beat
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.scheduler

        periodic-worker:
                image: lending-engine-services
                entrypoint: make periodic-worker
                env_file: .env
                depends_on:
                - flask
                - rabbitmq
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: lending-engine.periodic-worker

        rabbitmq:
                env_file: .env
                image: rabbitmq:3-management
                restart: unless-stopped
                networks:
                - lending-engine-net

        notif-grpc:
                image: notif-grpc
                env_file: .env
                entrypoint: python manage.py run
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: notif.grpc


        rdl-grpc:
                image: bni-rdl-grpc
                env_file: .env
                entrypoint: python manage.py run
                restart: unless-stopped
                networks:
                - lending-engine-net
                logging:
                  driver: "fluentd"
                  options:
                    fluentd-address: dev.modana.id:24224
                    tag: bni-rdl.grpc

networks:
  lending-engine-net:
    external: true
